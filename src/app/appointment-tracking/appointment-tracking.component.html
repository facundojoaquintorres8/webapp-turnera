<div class="container">
  <h2>Seguimiento de Turnos</h2>

  <form name="myFormFilter" role="form" novalidate (ngSubmit)="getAgendas()" [formGroup]="myFormFilter" class="mb-2">
    <div class="row">
      <div class="col-lg-4">
        <div class="form-group">
          <label class="form-control-label" for="resourceTypeId">Tipo de Recurso</label>
          <select class="form-control" name="resourceTypeId" id="resourceTypeId" formControlName="resourceTypeId"
            (change)="onResourceTypeChange()">
            <option [ngValue]="null"></option>
            <option [value]="resourceType.id" *ngFor="let resourceType of resourcesTypes">{{ resourceType.description }}
            </option>
          </select>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="form-group">
          <label class="form-control-label" for="resourceId">Recurso</label>
          <select class="form-control" name="resourceId" id="resourceId" formControlName="resourceId"
            (change)="onResourceChange()">
            <option [ngValue]="null"></option>
            <option [value]="resource.id" *ngFor="let resource of resources">{{ resource.description }} - {{
              resource.code }}
            </option>
          </select>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="form-group">
          <label class="form-control-label" for="customerId">Cliente</label>
          <select class="form-control" name="customerId" id="customerId" formControlName="customerId">
            <option [ngValue]="null"></option>
            <option [value]="customer.id" *ngFor="let customer of customers">{{ customer.businessName }}
            </option>
          </select>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-2">
        <div class="form-group">
          <label class="form-control-label required">Desde</label>
          <div class="input-group">
            <input class="form-control" placeholder="yyyy-mm-dd" name="from" formControlName="from" ngbDatepicker
              #from="ngbDatepicker" [firstDayOfWeek]="7" [maxDate]="maxDate()">
            <div class="input-group-append">
              <button class="btn btn-primary" (click)="from.toggle()" type="button" title="Ver Calendario">
                <i class="bi bi-calendar3"></i>
              </button>
            </div>
          </div>
          <div
            *ngIf="myFormFilter.get('from')!.invalid && (myFormFilter.get('from')!.dirty || myFormFilter.get('from')!.touched)">
            <small class="form-text text-danger" *ngIf="myFormFilter.get('from')?.errors?.required">
              El campo es requerido.
            </small>
          </div>
        </div>
      </div>
      <div class="col-lg-2">
        <div class="form-group">
          <label class="form-control-label required">Hasta</label>
          <div class="input-group">
            <input class="form-control" placeholder="yyyy-mm-dd" name="to" formControlName="to" ngbDatepicker
              #to="ngbDatepicker" [firstDayOfWeek]="7" [minDate]="minDate()">
            <div class="input-group-append">
              <button class="btn btn-primary" (click)="to.toggle()" type="button" title="Ver Calendario">
                <i class="bi bi-calendar3"></i>
              </button>
            </div>
          </div>
          <div
            *ngIf="myFormFilter.get('to')!.invalid && (myFormFilter.get('to')!.dirty || myFormFilter.get('to')!.touched)">
            <small class="form-text text-danger" *ngIf="myFormFilter.get('to')?.errors?.required">
              El campo es requerido.
            </small>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="form-group">
          <label class="form-control-label">&nbsp;</label>
          <div class="text-end">
            <button type="button" (click)="clear()" class="btn btn-secondary ms-2" [disabled]="isSearching"
              title="Limpiar">
              <i class="bi bi-skip-backward-circle"></i>&nbsp;Limpiar
            </button>
            <button type="submit" class="btn btn-outline-dark" [disabled]="myFormFilter.invalid || isSearching"
              title="Filtrar">
              <i class="bi bi-filter"></i>&nbsp;Filtrar
            </button>
          </div>
        </div>
      </div>
    </div>

  </form>


  <app-table [headers]="headers" [bodyTemplate]="customBody" [myForm]="myForm" [sort]="sort" [hasButtons]="true"
    [queryItems]="query" #tableComponent>

    <ng-template #customBody let-items>
      <tr *ngFor="let agenda of items">
        <td>{{ agenda.resource.description }}</td>
        <td>{{ agenda.startDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ agenda.endDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ agenda.lastAppointment ? agenda.lastAppointment.customerBusinessName : '-'}}</td>
        <td>
          <!-- TODO: arreglar lista porque no le gusta al angular nuevo -->
          <!-- <span class="{{ appointmentStatusColor(agenda.lastAppointment) }} appointmentStatus">
            {{ agenda.lastAppointment ? appointmentStatusObject[agenda.lastAppointment.lastAppointmentStatus.status] :
            appointmentStatusObject.FREE }}
          </span> -->
          <ng-container *ngIf="agenda.lastAppointment && agenda.lastAppointment.lastAppointmentStatus.observations">
            <i class="bi bi-chat-left-text text-info ms-1 pointer"
              (click)="seeObservations(agenda.lastAppointment.lastAppointmentStatus.observations)"
              [title]="'Observaciones: ' + agenda.lastAppointment.lastAppointmentStatus.observations"></i>
          </ng-container>
        </td>

        <td class="text-end">
          <button type="button" *ngIf="canBook(agenda)" (click)="book(agenda)" class="btn btn-warning btn-icon ms-1"
            title="Reservar turno">
            <i class="bi bi-plus-lg"></i>
          </button>

          <button type="button" *ngIf="canAttend(agenda)" (click)="attend(agenda.lastAppointment)"
            class="btn btn-info btn-icon ms-1" title="Atender">
            <i class="bi bi-play"></i>
          </button>

          <button type="button" *ngIf="canAbsent(agenda)" (click)="absent(agenda.lastAppointment)"
            class="btn btn-dark btn-icon ms-1" title="Ausentar">
            <i class="bi bi-person-slash"></i>
          </button>

          <button type="button" *ngIf="canCancel(agenda)" (click)="cancel(agenda.lastAppointment)"
            class="btn btn-danger btn-icon ms-1" title="Cancelar">
            <i class="bi bi-ban"></i>
          </button>

          <button type="button" *ngIf="canFinalize(agenda)" (click)="finalize(agenda.lastAppointment)"
            class="btn btn-success btn-icon ms-1" title="Finalizar">
            <i class="bi bi-person-check-fill"></i>
          </button>

          <button type="button" *ngIf="canDelete(agenda)" (click)="delete(agenda)" class="btn btn-danger btn-icon ms-1"
            title="Eliminar disponibilidad">
            <i class="bi bi-trash"></i>
          </button>

          <button type="button" *ngIf="canDesactivate(agenda)" (click)="desactivate(agenda)"
            class="btn btn-danger btn-icon ms-1" title="Desactivar disponibilidad">
            <i class="bi bi-calendar-x"></i>
          </button>
        </td>
      </tr>
    </ng-template>

  </app-table>
</div>